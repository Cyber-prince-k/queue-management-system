<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Patient Portal - QECH Queue System [v20251022-1216]</title>
  <link rel="stylesheet" href="/queue%20system/css/style.css" />
</head>
<body>
  <header>
    <div class="container">
      <div class="logo-container">
        <div>
          <img src="https://via.placeholder.com/60x60/2c7fb8/ffffff?text=QECH" alt="QECH Logo" class="logo" />
          <div>
            <h1 data-i18n="hospital_name">Queen Elizabeth Central Hospital</h1>
            <h2 data-i18n="system_name">Digital Queue Management System</h2>
          </div>
        </div>
      </div>
      <nav aria-label="Primary">
        <ul>
          <li><a class="btn btn-secondary" href="../index.html" data-i18n="nav_home">Home</a></li>
          <li><a class="btn btn-secondary" href="patient.html" data-i18n="nav_patient">Patient</a></li>
          <li><a class="btn btn-secondary" href="queues.html" data-i18n="nav_queues">Queues</a></li>
          <li><a class="btn btn-primary" href="display.html" data-i18n="nav_display">Public Display</a></li>
          <li id="user-info" style="display: flex; align-items: center; gap: 0.5rem;"></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section id="patient-section" class="card">
      <div class="section-header">
        <h2 data-i18n="patient_access">Patient Access</h2>
      </div>

      <div class="tabs" role="tablist" aria-label="Patient Actions">
        <button class="tab-btn active" data-tab="register-tab" role="tab" aria-selected="true" aria-controls="register-tab">Register</button>
        <button class="tab-btn" data-tab="queue-status-tab" role="tab" aria-selected="false" aria-controls="queue-status-tab">Queue Status</button>
        <button class="tab-btn" data-tab="appointment-tab" role="tab" aria-selected="false" aria-controls="appointment-tab">Book Appointment</button>
      </div>

      <section id="register-tab" class="tab-content active" role="tabpanel" aria-labelledby="Register">
        <div class="info-banner" style="background: #dbeafe; border-left: 4px solid #2563eb; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px;">
          <h3 style="margin-top: 0; color: #1e40af; font-size: 1.1rem;">üìã Queue Registration</h3>
          <p style="margin: 0.5rem 0; color: #1e3a8a; line-height: 1.6;">
            Please fill in your details below and select the department you wish to visit. 
            Once submitted, you will receive a queue token number and be placed in line for service at your selected department.
            Your request will appear on the staff dashboard for processing.
          </p>
        </div>

        <h3>Patient Registration & Queue Request</h3>
        <form id="patient-registration-form">
          <div class="form-group">
            <label for="patient-name">Full Name <span style="color: #ef4444;">*</span></label>
            <input type="text" id="patient-name" name="patient-name" placeholder="Enter your full name" required />
          </div>
          
          <div class="form-group">
            <label for="patient-age">Age <span style="color: #ef4444;">*</span></label>
            <input type="number" id="patient-age" name="patient-age" min="0" max="150" placeholder="Enter your age" required />
          </div>
          
          <div class="form-group">
            <label for="patient-phone">Phone Number <span style="color: #ef4444;">*</span></label>
            <input type="tel" id="patient-phone" name="patient-phone" placeholder="e.g., +265 999 123 456" required />
          </div>
          
          <div class="form-group">
            <label for="patient-id">ID Number <span style="color: #ef4444;">*</span></label>
            <input type="text" id="patient-id" name="patient-id" placeholder="National ID or Passport Number" required />
          </div>
          
          <div class="form-group">
            <label for="patient-address">Address</label>
            <textarea id="patient-address" name="patient-address" rows="2" placeholder="Your residential address (optional)"></textarea>
          </div>
          
          <div class="form-group">
            <label for="patient-department">Department to Visit <span style="color: #ef4444;">*</span></label>
            <select id="patient-department" name="patient-department" required>
              <option value="">-- Select Department --</option>
              <option value="opd">Outpatient Department (OPD)</option>
              <option value="maternity">Maternity</option>
              <option value="emergency">Emergency</option>
              <option value="pediatrics">Pediatrics</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="service-type">Service Required</label>
            <input type="text" id="service-type" name="service-type" placeholder="e.g., Consultation, Check-up, Follow-up" />
          </div>
          
          <div class="form-group">
            <label for="priority-case">Priority Case</label>
            <select id="priority-case" name="priority-case">
              <option value="no">No Priority</option>
              <option value="emergency">Emergency</option>
              <option value="elderly">Elderly (65+)</option>
              <option value="pregnant">Pregnant</option>
              <option value="disability">Disability</option>
            </select>
            <small style="color: #64748b; display: block; margin-top: 0.25rem;">Select if you qualify for priority service</small>
          </div>
          
          <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin: 1rem 0; border-radius: 8px;">
            <p style="margin: 0; color: #92400e; font-size: 0.9rem;">
              <strong>‚ö†Ô∏è Important:</strong> After submitting, you will receive a token number. Please keep this number safe as you will need it to check your queue position.
            </p>
          </div>
          
          <button type="submit" class="btn btn-primary" style="width: 100%; padding: 0.75rem; font-size: 1.1rem;">
            üìù Submit & Join Queue
          </button>
        </form>
        
        <div id="token-display" style="margin-top: 1.5rem;"></div>
      </section>

      <section id="queue-status-tab" class="tab-content" role="tabpanel" aria-labelledby="Queue Status">
        <h3>Check Queue Status</h3>
        <form id="queue-status-form">
          <div class="form-group">
            <label for="queue-token">Token Number</label>
            <input type="text" id="queue-token" name="queue-token" required />
          </div>
          <button type="submit" class="btn btn-primary">Check Status</button>
        </form>
        <div id="queue-status-result" class="queue-display hidden" aria-live="polite"></div>
      </section>

      <section id="appointment-tab" class="tab-content" role="tabpanel" aria-labelledby="Book Appointment">
        <div class="info-banner" style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px;">
          <h3 style="margin-top: 0; color: #047857; font-size: 1.1rem;">üìÖ Book an Appointment</h3>
          <p style="margin: 0.5rem 0; color: #065f46; line-height: 1.6;">
            Schedule your visit in advance by booking an appointment. Choose your preferred date, time, and department.
            You will receive an appointment confirmation number that you can use to check your appointment status.
          </p>
        </div>

        <h3>Schedule Your Appointment</h3>
        <form id="appointment-booking-form">
          <div class="form-group">
            <label for="appt-patient-name">Full Name <span style="color: #ef4444;">*</span></label>
            <input type="text" id="appt-patient-name" name="appt-patient-name" placeholder="Enter your full name" required />
          </div>
          
          <div class="form-group">
            <label for="appt-patient-age">Age</label>
            <input type="number" id="appt-patient-age" name="appt-patient-age" min="0" max="150" placeholder="Enter your age" />
          </div>
          
          <div class="form-group">
            <label for="appt-patient-phone">Phone Number <span style="color: #ef4444;">*</span></label>
            <input type="tel" id="appt-patient-phone" name="appt-patient-phone" placeholder="e.g., +265 999 123 456" required />
          </div>
          
          <div class="form-group">
            <label for="appt-patient-id">ID Number</label>
            <input type="text" id="appt-patient-id" name="appt-patient-id" placeholder="National ID or Passport Number" />
          </div>
          
          <div class="form-group">
            <label for="appt-patient-email">Email Address</label>
            <input type="email" id="appt-patient-email" name="appt-patient-email" placeholder="your.email@example.com" />
          </div>
          
          <div class="form-group">
            <label for="appt-department">Department <span style="color: #ef4444;">*</span></label>
            <select id="appt-department" name="appt-department" required>
              <option value="">-- Select Department --</option>
              <option value="opd">Outpatient Department (OPD)</option>
              <option value="maternity">Maternity</option>
              <option value="emergency">Emergency</option>
              <option value="pediatrics">Pediatrics</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="appt-date">Appointment Date <span style="color: #ef4444;">*</span></label>
            <input type="date" id="appt-date" name="appt-date" required />
            <small style="color: #64748b; display: block; margin-top: 0.25rem;">Select a date for your appointment</small>
          </div>
          
          <div class="form-group">
            <label for="appt-time">Preferred Time <span style="color: #ef4444;">*</span></label>
            <select id="appt-time" name="appt-time" required>
              <option value="">-- Select Time --</option>
            </select>
            <small style="color: #64748b; display: block; margin-top: 0.25rem;">Available time slots will appear after selecting date and department</small>
          </div>
          
          <div class="form-group">
            <label for="appt-service-type">Service Required</label>
            <input type="text" id="appt-service-type" name="appt-service-type" placeholder="e.g., Consultation, Check-up, Follow-up" />
          </div>
          
          <div class="form-group">
            <label for="appt-reason">Reason for Visit</label>
            <textarea id="appt-reason" name="appt-reason" rows="3" placeholder="Brief description of your medical concern (optional)"></textarea>
          </div>
          
          <div class="form-group">
            <label for="appt-priority">Priority Case</label>
            <select id="appt-priority" name="appt-priority">
              <option value="no">No Priority</option>
              <option value="emergency">Emergency</option>
              <option value="elderly">Elderly (65+)</option>
              <option value="pregnant">Pregnant</option>
              <option value="disability">Disability</option>
            </select>
            <small style="color: #64748b; display: block; margin-top: 0.25rem;">Select if you qualify for priority service</small>
          </div>
          
          <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin: 1rem 0; border-radius: 8px;">
            <p style="margin: 0; color: #92400e; font-size: 0.9rem;">
              <strong>‚ö†Ô∏è Important:</strong> After booking, you will receive an appointment confirmation number. Please arrive 15 minutes before your scheduled time.
            </p>
          </div>
          
          <button type="submit" class="btn btn-primary" style="width: 100%; padding: 0.75rem; font-size: 1.1rem;">
            üìÖ Book Appointment
          </button>
        </form>
        
        <div id="appointment-confirmation" style="margin-top: 1.5rem;"></div>
        
        <div style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #e5e7eb;">
          <h3>Check Appointment Status</h3>
          <form id="appointment-status-form">
            <div class="form-group">
              <label for="appt-number">Appointment Number</label>
              <input type="text" id="appt-number" name="appt-number" placeholder="Enter your appointment number" required />
            </div>
            <button type="submit" class="btn btn-secondary">Check Appointment</button>
          </form>
          <div id="appointment-status-result" style="margin-top: 1rem;"></div>
        </div>
      </section>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>About QECH</h3>
          <p>Queen Elizabeth Central Hospital is Malawi's largest referral hospital, providing quality healthcare services to the nation.</p>
        </div>
        <div class="footer-section">
          <h3>Quick Links</h3>
          <ul>
            <li><a href="patient.html">Patient Portal</a></li>
            <li><a href="staff.html">Staff Portal</a></li>
            <li><a href="admin.html">Admin Portal</a></li>
            <li><a href="display.html">Public Display</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3>Contact</h3>
          <p>Queen Elizabeth Central Hospital<br>
          Blantyre, Malawi<br>
          Phone: +265 1 871 111</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p>&copy; 2023 Queen Elizabeth Central Hospital - Digital Queue Management System</p>
        
      </div>
    </div>
  </footer>

  <script src="/queue%20system/js/auth.js?v=20251022095900" onerror="console.error('Failed to load auth.js')"></script>
  <script src="/queue%20system/js/style.js?v=20251022095900" onerror="console.error('Failed to load style.js')"></script>
  
  <!-- Print styles for token -->
  <style>
    @media print {
        body * {
            visibility: hidden;
        }
        #token-display, #token-display * {
            visibility: visible;
        }
        #token-display {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
        }
        #token-display button {
            display: none !important;
        }
    }
  </style>
  
  <!-- ALL SCRIPTS IN ONE BLOCK -->
  <script>
    // Catch any uncaught errors
    window.addEventListener('error', function(e) {
      console.error('‚ùå UNCAUGHT ERROR:', e.error);
      console.error('Message:', e.message);
      console.error('File:', e.filename);
      console.error('Line:', e.lineno);
    });
    
    console.log('=== PATIENT.HTML SCRIPT STARTING ===');
    
    // Define API_BASE_URL only if not already defined
    if (typeof API_BASE_URL === 'undefined') {
      var API_BASE_URL = 'http://localhost/queue%20system/php/api';
    }
    console.log('‚úì API_BASE_URL:', API_BASE_URL);
    
    // Create new queue token (Patient Registration)
    async function createQueueToken(patientData) {
        try {
            console.log('createQueueToken called with:', patientData);
            
            const response = await fetch(`${API_BASE_URL}/queue.php?action=create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify(patientData)
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                const errorText = await response.text();
                console.error('Server response:', errorText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            console.log('Response data:', data);
            console.log('Token data:', data.token);

            if (data.success && data.token) {
                console.log('‚úì Token created, calling displayTokenDetails...');
                // Display token details
                displayTokenDetails(data.token);
                console.log('‚úì displayTokenDetails called');
            } else {
                console.error('‚ùå Token creation failed or no token in response');
                console.error('Success:', data.success);
                console.error('Token:', data.token);
            }

            return data;
        } catch (error) {
            console.error('Create token error:', error);
            return { success: false, message: error.message };
        }
    }
    
    // Display token details
    function displayTokenDetails(token) {
        console.log('displayTokenDetails called with:', token);
        const tokenDisplay = document.getElementById('token-display');
        if (!tokenDisplay) {
            console.error('‚ùå token-display element not found!');
            return;
        }
        console.log('‚úì token-display element found');
        
        tokenDisplay.innerHTML = `
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 2rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; color: white;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">üé´</div>
                <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: bold;">Token Created Successfully!</h3>
                
                <div style="background: rgba(255,255,255,0.95); padding: 1.5rem; border-radius: 12px; margin: 1rem 0; color: #1e293b;">
                    <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">Your Token Number</p>
                    <p style="font-size: 2.5rem; font-weight: bold; margin: 0; color: #2563eb; font-family: monospace; letter-spacing: 2px;">
                        ${token.token_number}
                    </p>
                </div>
                
                <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                    <p style="margin: 0; font-size: 1.1rem;">
                        <strong>Queue Position:</strong> <span style="font-size: 1.3rem; font-weight: bold;">#${token.queue_position}</span>
                    </p>
                </div>
                
                <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #fbbf24;">
                    <p style="margin: 0; font-size: 0.95rem; line-height: 1.6;">
                        ‚ö†Ô∏è <strong>Important:</strong> Please save this token number. You will need it to check your queue status.
                    </p>
                </div>
                
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button onclick="window.print()" type="button" class="btn" style="background: white; color: #667eea; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                        üñ®Ô∏è Print Token
                    </button>
                    <button onclick="copyTokenNumber('${token.token_number}')" type="button" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem 1.5rem; border: 2px solid white; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                        üìã Copy Number
                    </button>
                </div>
            </div>
        `;
        tokenDisplay.classList.remove('hidden');
        console.log('‚úì Token display updated and made visible');
        
        // Scroll to token display
        setTimeout(() => {
            tokenDisplay.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            console.log('‚úì Scrolled to token display');
        }, 100);
    }
    
    // Copy token number to clipboard
    function copyTokenNumber(tokenNumber) {
        console.log('Copying token:', tokenNumber);
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(tokenNumber).then(() => {
                if (typeof showToast === 'function') {
                    showToast('success', '‚úì Token number copied to clipboard');
                }
            }).catch(err => {
                console.error('Failed to copy:', err);
                fallbackCopy(tokenNumber);
            });
        } else {
            fallbackCopy(tokenNumber);
        }
    }
    
    // Fallback copy method
    function fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            if (typeof showToast === 'function') {
                showToast('success', '‚úì Token number copied');
            }
        } catch (err) {
            if (typeof showToast === 'function') {
                showToast('error', 'Could not copy. Please write it down: ' + text);
            }
        }
        document.body.removeChild(textArea);
    }
    
    console.log('‚úì Queue functions defined');
    
    // ===== APPOINTMENT FUNCTIONS =====
    
    // Create new appointment
    async function createAppointment(appointmentData) {
        try {
            console.log('createAppointment called with:', appointmentData);
            
            const response = await fetch(`${API_BASE_URL}/appointments.php?action=create`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(appointmentData)
            });

            console.log('Response status:', response.status);

            if (!response.ok) {
                const txt = await response.text();
                console.error('Server response:', txt);
                try {
                    const maybeJson = JSON.parse(txt);
                    return { success: false, message: maybeJson.message || `HTTP ${response.status}` };
                } catch (_) {
                    return { success: false, message: `HTTP ${response.status}: ${txt.substring(0,200)}` };
                }
            }

            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                const txt = await response.text();
                return { success: false, message: `Non-JSON response: ${txt.substring(0,200)}` };
            }

            const data = await response.json();
            console.log('Response data:', data);

            return data;
        } catch (error) {
            console.error('Create appointment error:', error);
            return { success: false, message: error.message };
        }
    }
    
    // Get available time slots
    async function getAvailableSlots(department, date) {
        try {
            const response = await fetch(`${API_BASE_URL}/appointments.php?action=available-slots&department=${department}&date=${date}&_=${Date.now()}`, {
                method: 'GET'
            });

            if (!response.ok) {
                const txt = await response.text();
                return { success: false, message: `HTTP ${response.status}: ${txt.substring(0,120)}` };
            }

            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                const txt = await response.text();
                return { success: false, message: `Non-JSON response: ${txt.substring(0,120)}` };
            }

            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Get available slots error:', error);
            return { success: false, message: error.message };
        }
    }
    
    // Get appointment by number
    async function getAppointmentByNumber(appointmentNumber) {
        try {
            const response = await fetch(`${API_BASE_URL}/appointments.php?action=get&appointment_number=${appointmentNumber}`, {
                method: 'GET'
            });

            if (!response.ok) {
                const txt = await response.text();
                return { success: false, message: `HTTP ${response.status}: ${txt.substring(0,120)}` };
            }

            const ct = response.headers.get('content-type') || '';
            if (!ct.includes('application/json')) {
                const txt = await response.text();
                return { success: false, message: `Non-JSON response: ${txt.substring(0,120)}` };
            }

            const data = await response.json();
            return data;
        } catch (error) {
            console.error('Get appointment error:', error);
            return { success: false, message: error.message };
        }
    }
    
    // Display appointment confirmation
    function displayAppointmentConfirmation(appointment) {
        console.log('displayAppointmentConfirmation called with:', appointment);
        const confirmationDiv = document.getElementById('appointment-confirmation');
        if (!confirmationDiv) {
            console.error('‚ùå appointment-confirmation element not found!');
            return;
        }
        
        const appointmentDate = new Date(appointment.appointment_date + ' ' + appointment.appointment_time);
        const formattedDate = appointmentDate.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        const formattedTime = appointmentDate.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        confirmationDiv.innerHTML = `
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 2rem; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); text-align: center; color: white;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                <h3 style="margin: 0 0 1rem 0; font-size: 1.5rem; font-weight: bold;">Appointment Booked Successfully!</h3>
                
                <div style="background: rgba(255,255,255,0.95); padding: 1.5rem; border-radius: 12px; margin: 1rem 0; color: #1e293b;">
                    <p style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #64748b; text-transform: uppercase; letter-spacing: 1px;">Your Appointment Number</p>
                    <p style="font-size: 2.5rem; font-weight: bold; margin: 0; color: #10b981; font-family: monospace; letter-spacing: 2px;">
                        ${appointment.appointment_number}
                    </p>
                </div>
                
                <div style="background: rgba(255,255,255,0.2); padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left;">
                    <p style="margin: 0.5rem 0; font-size: 1rem;">
                        <strong>Patient:</strong> ${appointment.patient_name}
                    </p>
                    <p style="margin: 0.5rem 0; font-size: 1rem;">
                        <strong>Department:</strong> ${appointment.department_name}
                    </p>
                    <p style="margin: 0.5rem 0; font-size: 1rem;">
                        <strong>Date:</strong> ${formattedDate}
                    </p>
                    <p style="margin: 0.5rem 0; font-size: 1rem;">
                        <strong>Time:</strong> ${formattedTime}
                    </p>
                </div>
                
                <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 8px; margin-top: 1rem; border-left: 4px solid #fbbf24;">
                    <p style="margin: 0; font-size: 0.95rem; line-height: 1.6;">
                        ‚ö†Ô∏è <strong>Important:</strong> Please arrive 15 minutes before your scheduled time. Save your appointment number for reference.
                    </p>
                </div>
                
                <div style="margin-top: 1.5rem; display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button onclick="window.print()" type="button" class="btn" style="background: white; color: #10b981; padding: 0.75rem 1.5rem; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                        üñ®Ô∏è Print Confirmation
                    </button>
                    <button onclick="copyAppointmentNumber('${appointment.appointment_number}')" type="button" class="btn" style="background: rgba(255,255,255,0.2); color: white; padding: 0.75rem 1.5rem; border: 2px solid white; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1rem;">
                        üìã Copy Number
                    </button>
                </div>
            </div>
        `;
        
        // Scroll to confirmation
        setTimeout(() => {
            confirmationDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }, 100);
    }
    
    // Copy appointment number to clipboard
    function copyAppointmentNumber(appointmentNumber) {
        console.log('Copying appointment number:', appointmentNumber);
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(appointmentNumber).then(() => {
                if (typeof showToast === 'function') {
                    showToast('success', '‚úì Appointment number copied to clipboard');
                }
            }).catch(err => {
                console.error('Failed to copy:', err);
                fallbackCopy(appointmentNumber);
            });
        } else {
            fallbackCopy(appointmentNumber);
        }
    }
    
    // Load available time slots when date and department are selected
    async function loadTimeSlots() {
        const department = document.getElementById('appt-department').value;
        const date = document.getElementById('appt-date').value;
        const timeSelect = document.getElementById('appt-time');
        
        if (!department || !date) {
            timeSelect.innerHTML = '<option value="">-- Select Time --</option>';
            return;
        }
        
        timeSelect.innerHTML = '<option value="">Loading...</option>';
        
        const result = await getAvailableSlots(department, date);
        
        if (result && result.success && Array.isArray(result.slots) && result.slots.length > 0) {
            timeSelect.innerHTML = '<option value="">-- Select Time --</option>';
            
            result.slots.forEach(slot => {
                const time = slot.time.substring(0, 5); // Remove seconds
                const option = document.createElement('option');
                option.value = slot.time;
                option.textContent = `${time} ${slot.available ? '(Available)' : '(Fully Booked)'}`;
                option.disabled = !slot.available;
                timeSelect.appendChild(option);
            });
        } else {
            // Graceful fallback: populate default half-hour slots 08:00 - 16:00
            const defaults = [];
            for (let h = 8; h < 16; h++) {
                for (let m = 0; m < 60; m += 30) {
                    const hh = String(h).padStart(2, '0');
                    const mm = String(m).padStart(2, '0');
                    defaults.push(`${hh}:${mm}:00`);
                }
            }
            timeSelect.innerHTML = '<option value="">-- Select Time --</option>';
            defaults.forEach(t => {
                const opt = document.createElement('option');
                opt.value = t;
                opt.textContent = `${t.substring(0,5)} (Available)`;
                timeSelect.appendChild(opt);
            });
            if (typeof showToast === 'function') {
                showToast('info', 'Showing default time slots');
            }
        }
    }
    
    console.log('‚úì Appointment functions defined');
    
    // ===== FORM HANDLERS =====
    // Wait for DOM to be ready
    window.addEventListener('load', function() {
      console.log('=== PAGE LOAD DEBUG ===');
      console.log('createQueueToken:', typeof createQueueToken);
      console.log('showToast:', typeof showToast);
      console.log('requireRole:', typeof requireRole);
      
      // Patient registration form handler - ALWAYS attach this
      const form = document.getElementById('patient-registration-form');
      if (!form) {
        console.error('‚ùå Form not found!');
        return;
      }
      
      console.log('‚úì Form found, attaching handler...');
      
      form.addEventListener('submit', async (e) => {
      e.preventDefault();
      console.log('=== FORM SUBMITTED ===');
      
      // Check if createQueueToken exists NOW (at submit time)
      if (typeof createQueueToken !== 'function') {
        console.error('‚ùå createQueueToken not available at submit time!');
        console.error('Skipping check - function should be defined inline above');
        // Don't return - the function is defined inline, so it should exist
      }
      
      console.log('Form submitted - starting patient registration...');
      
      const patientData = {
        patient_name: document.getElementById('patient-name').value,
        patient_age: parseInt(document.getElementById('patient-age').value),
        patient_phone: document.getElementById('patient-phone').value,
        patient_id_number: document.getElementById('patient-id').value,
        patient_address: document.getElementById('patient-address').value,
        service_type: document.getElementById('service-type').value,
        department: document.getElementById('patient-department').value,
        priority_type: document.getElementById('priority-case').value
      };
      
      console.log('Patient data:', patientData);
      
      // Auto-set priority for elderly
      if (patientData.patient_age >= 65 && patientData.priority_type === 'no') {
        patientData.priority_type = 'elderly';
        console.log('Auto-set priority to elderly');
      }
      
      const submitBtn = e.target.querySelector('button[type="submit"]');
      submitBtn.disabled = true;
      submitBtn.textContent = '‚è≥ Creating Token...';
      
      try {
        console.log('Calling createQueueToken...');
        const result = await createQueueToken(patientData);
        console.log('Result from createQueueToken:', result);
        
        if (result && result.success) {
          console.log('Token created successfully:', result.token);
          
          // Show success message
          if (typeof showToast === 'function') {
            showToast('success', '‚úì Token created successfully!');
          }
          
          // Clear form
          e.target.reset();
          
          // Scroll to token display
          const tokenDisplay = document.getElementById('token-display');
          if (tokenDisplay) {
            console.log('Scrolling to token display');
            setTimeout(() => {
              tokenDisplay.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 200);
          } else {
            console.error('Token display element not found!');
          }
        } else {
          console.error('Token creation failed:', result);
          const errorMsg = result?.message || 'Failed to create token. Please try again.';
          if (typeof showToast === 'function') {
            showToast('error', errorMsg);
          }
        }
      } catch (error) {
        console.error('Error submitting form:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          name: error.name
        });
        const errorMsg = `An error occurred: ${error.message}. Please check the console for details.`;
        if (typeof showToast === 'function') {
          showToast('error', errorMsg);
        }
      } finally {
        // Always re-enable button
        console.log('Re-enabling submit button');
        submitBtn.disabled = false;
        submitBtn.textContent = 'üìù Submit & Join Queue';
      }
    });

    // Queue status check form handler
    document.getElementById('queue-status-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const tokenNumber = document.getElementById('queue-token').value;
      
      if (!tokenNumber) {
        showToast('error', 'Please enter a token number');
        return;
      }
      
      showToast('info', 'Checking status...');
      
      // Get all tokens and find the matching one
      const allTokens = await getQueueStatus();
      const token = allTokens.find(t => t.token_number === tokenNumber);
      
      const resultDiv = document.getElementById('queue-status-result');
      
      if (token) {
        const position = allTokens.filter(t => 
          t.department_id === token.department_id && 
          t.status === 'waiting' && 
          t.queue_position <= token.queue_position
        ).length;
        
        resultDiv.innerHTML = `
          <div style="background: #e0f2fe; padding: 1.5rem; border-radius: 12px; border: 2px solid #2563eb;">
            <h3 style="margin-top: 0; color: #2563eb;">Token Status</h3>
            <p><strong>Token Number:</strong> ${token.token_number}</p>
            <p><strong>Patient Name:</strong> ${token.patient_name}</p>
            <p><strong>Department:</strong> ${token.department_name}</p>
            <p><strong>Status:</strong> <span style="color: ${token.status === 'serving' ? '#10b981' : '#f59e0b'}; font-weight: bold; text-transform: uppercase;">${token.status}</span></p>
            <p><strong>Queue Position:</strong> ${position}</p>
            ${token.priority_type !== 'no' ? `<p><strong>Priority:</strong> ${token.priority_type}</p>` : ''}
          </div>
        `;
        resultDiv.classList.remove('hidden');
        showToast('success', 'Token found!');
      } else {
        resultDiv.innerHTML = `
          <div style="background: #fee; padding: 1.5rem; border-radius: 12px; border: 2px solid #ef4444;">
            <p style="color: #ef4444; margin: 0;">Token not found or already completed.</p>
          </div>
        `;
        resultDiv.classList.remove('hidden');
        showToast('error', 'Token not found');
      }
    });
    
    // ===== APPOINTMENT FORM HANDLERS =====
    
    // Set minimum date to today
    const apptDateInput = document.getElementById('appt-date');
    if (apptDateInput) {
      const today = new Date().toISOString().split('T')[0];
      apptDateInput.setAttribute('min', today);
    }
    
    // Load time slots when department or date changes
    const apptDepartment = document.getElementById('appt-department');
    const apptDate = document.getElementById('appt-date');
    
    if (apptDepartment && apptDate) {
      apptDepartment.addEventListener('change', loadTimeSlots);
      apptDate.addEventListener('change', loadTimeSlots);
      // Also trigger when appointment tab is opened, if both values already selected
      const apptTabBtn = document.querySelector('.tab-btn[data-tab="appointment-tab"]');
      if (apptTabBtn) {
        apptTabBtn.addEventListener('click', () => {
          if (apptDepartment.value && apptDate.value) {
            loadTimeSlots();
          }
        });
      }
    }
    
    // Appointment booking form handler
    const appointmentForm = document.getElementById('appointment-booking-form');
    if (appointmentForm) {
      appointmentForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        console.log('=== APPOINTMENT FORM SUBMITTED ===');
        
        const appointmentData = {
          patient_name: document.getElementById('appt-patient-name').value,
          patient_age: document.getElementById('appt-patient-age').value || null,
          patient_phone: document.getElementById('appt-patient-phone').value,
          patient_id_number: document.getElementById('appt-patient-id').value || null,
          patient_email: document.getElementById('appt-patient-email').value || null,
          department: document.getElementById('appt-department').value,
          appointment_date: document.getElementById('appt-date').value,
          appointment_time: document.getElementById('appt-time').value,
          service_type: document.getElementById('appt-service-type').value || null,
          reason: document.getElementById('appt-reason').value || null,
          priority_type: document.getElementById('appt-priority').value || 'no'
        };
        
        console.log('Appointment data:', appointmentData);
        
        // Auto-set priority for elderly
        if (appointmentData.patient_age >= 65 && appointmentData.priority_type === 'no') {
          appointmentData.priority_type = 'elderly';
          console.log('Auto-set priority to elderly');
        }
        
        const submitBtn = e.target.querySelector('button[type="submit"]');
        submitBtn.disabled = true;
        submitBtn.textContent = '‚è≥ Booking Appointment...';
        
        try {
          console.log('Calling createAppointment...');
          const result = await createAppointment(appointmentData);
          console.log('Result from createAppointment:', result);
          
          if (result && result.success) {
            console.log('Appointment created successfully:', result.appointment);
            
            // Show success message
            if (typeof showToast === 'function') {
              showToast('success', '‚úì Appointment booked successfully!');
            }
            
            // Display confirmation
            displayAppointmentConfirmation(result.appointment);
            
            // Clear form
            e.target.reset();
            
            // Reset time slots
            document.getElementById('appt-time').innerHTML = '<option value="">-- Select Time --</option>';
            
          } else {
            console.error('Appointment booking failed:', result);
            const errorMsg = result?.message || 'Failed to book appointment. Please try again.';
            if (typeof showToast === 'function') {
              showToast('error', errorMsg);
            }
          }
        } catch (error) {
          console.error('Error submitting appointment form:', error);
          const errorMsg = `An error occurred: ${error.message}. Please check the console for details.`;
          if (typeof showToast === 'function') {
            showToast('error', errorMsg);
          }
        } finally {
          // Always re-enable button
          console.log('Re-enabling submit button');
          submitBtn.disabled = false;
          submitBtn.textContent = 'üìÖ Book Appointment';
        }
      });
    }
    
    // Appointment status check form handler
    const appointmentStatusForm = document.getElementById('appointment-status-form');
    if (appointmentStatusForm) {
      appointmentStatusForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const appointmentNumber = document.getElementById('appt-number').value;
        
        if (!appointmentNumber) {
          if (typeof showToast === 'function') {
            showToast('error', 'Please enter an appointment number');
          }
          return;
        }
        
        if (typeof showToast === 'function') {
          showToast('info', 'Checking appointment status...');
        }
        
        const result = await getAppointmentByNumber(appointmentNumber);
        const resultDiv = document.getElementById('appointment-status-result');
        
        if (result.success && result.appointment) {
          const appt = result.appointment;
          const appointmentDate = new Date(appt.appointment_date + ' ' + appt.appointment_time);
          const formattedDate = appointmentDate.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
          });
          const formattedTime = appointmentDate.toLocaleTimeString('en-US', { 
            hour: '2-digit', 
            minute: '2-digit' 
          });
          
          const statusColors = {
            'pending': '#f59e0b',
            'confirmed': '#10b981',
            'completed': '#6b7280',
            'cancelled': '#ef4444'
          };
          
          resultDiv.innerHTML = `
            <div style="background: #f0fdf4; padding: 1.5rem; border-radius: 12px; border: 2px solid #10b981;">
              <h3 style="margin-top: 0; color: #047857;">Appointment Details</h3>
              <p><strong>Appointment Number:</strong> ${appt.appointment_number}</p>
              <p><strong>Patient Name:</strong> ${appt.patient_name}</p>
              <p><strong>Department:</strong> ${appt.department_name}</p>
              <p><strong>Date:</strong> ${formattedDate}</p>
              <p><strong>Time:</strong> ${formattedTime}</p>
              <p><strong>Status:</strong> <span style="color: ${statusColors[appt.status]}; font-weight: bold; text-transform: uppercase;">${appt.status}</span></p>
              ${appt.service_type ? `<p><strong>Service:</strong> ${appt.service_type}</p>` : ''}
              ${appt.priority_type !== 'no' ? `<p><strong>Priority:</strong> ${appt.priority_type}</p>` : ''}
            </div>
          `;
          
          if (typeof showToast === 'function') {
            showToast('success', 'Appointment found!');
          }
        } else {
          resultDiv.innerHTML = `
            <div style="background: #fee2e2; padding: 1.5rem; border-radius: 12px; border: 2px solid #ef4444;">
              <p style="color: #ef4444; margin: 0;">Appointment not found. Please check the number and try again.</p>
            </div>
          `;
          
          if (typeof showToast === 'function') {
            showToast('error', 'Appointment not found');
          }
        }
      });
    }
    
    }); // End window.addEventListener('load')
  </script>
</body>
</html>
