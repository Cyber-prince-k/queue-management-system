<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Staff Portal - QECH Queue System</title>
  <link rel="stylesheet" href="../css/style.css" />
</head>
<body>
  <header>
    <div class="container">
      <div class="logo-container">
        <div>
          <img src="../images/Screenshot 2025-11-01 111731.png" alt="QECH Logo" class="logo" />
          <div>
            <h1 data-i18n="hospital_name">Queen Elizabeth Central Hospital</h1>
            <h2 data-i18n="system_name">Queue Management System</h2>
          </div>
        </div>
      </div>
      <nav aria-label="Primary">
        <ul>
          <li><a class="btn btn-secondary" href="../index.html" data-i18n="nav_home">Home</a></li>
          <li id="user-info" style="display: flex; align-items: center; gap: 0.5rem;"></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="container">
    <section id="staff-section" class="card">
      <div class="section-header">
        <h2 data-i18n="staff_access">Staff Access</h2>
      </div>

      <div class="info-banner" style="background: #dbeafe; border-left: 4px solid #2563eb; padding: 1rem; margin-bottom: 1.5rem; border-radius: 8px;">
        <h3 style="margin-top: 0; color: #1e40af; font-size: 1.1rem;">STAFF CONTROLS</h3>
        <p style="margin: 0.5rem 0; color: #1e3a8a; line-height: 1.6;">
          Hospital staff have special access to manage the queues through the system. You can <strong>pause or resume queues</strong>, 
          <strong>reassign patients</strong> to another department, or <strong>mark patients as attended</strong>. 
          Every action you perform is updated in the database, ensuring the system always reflects the current situation. 
          This control feature helps staff maintain order and efficiency in patient handling.
        </p>
      </div>

      <div class="department-selector">
        <label for="staff-department">Select Department:</label>
        <select id="staff-department" name="staff-department">
          <option value="opd">Outpatient Department (OPD)</option>
          <option value="maternity">Maternity</option>
          <option value="emergency">Emergency</option>
          <option value="pediatrics">Pediatrics</option>
        </select>
      </div>

      <div class="queue-controls">
        <h3>Queue Management</h3>
        <div class="control-buttons">
          <button id="call-next-btn" class="btn btn-primary">Call Next Patient</button>
          <button id="pause-queue-btn" class="btn btn-secondary">Pause Queue</button>
          <button id="resume-queue-btn" class="btn btn-success">Resume Queue</button>
        </div>
      </div>

      <div id="queue-summary" style="background: linear-gradient(135deg, #dbeafe 0%, #e0f2fe 100%); padding: 1rem; border-radius: 12px; margin: 1.5rem 0; display: flex; gap: 2rem; flex-wrap: wrap; justify-content: space-around;">
        <div style="text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: #2563eb;" id="total-waiting">0</div>
          <div style="color: #1e40af; font-size: 0.9rem;">Patients Waiting</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: #10b981;" id="currently-serving">0</div>
          <div style="color: #065f46; font-size: 0.9rem;">Currently Serving</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 2rem; font-weight: bold; color: #f59e0b;" id="priority-patients">0</div>
          <div style="color: #92400e; font-size: 0.9rem;">Priority Cases</div>
        </div>
      </div>

      <div class="current-queue">
        <h3>Current Queue <span id="queue-count-badge" style="background: #2563eb; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.9rem; margin-left: 0.5rem;">0</span></h3>
        <div id="queue-list" class="queue-display" aria-live="polite"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <div class="footer-content">
        <div class="footer-section">
          <h3>About QECH</h3>
          <p>Queen Elizabeth Central Hospital is Malawi's largest referral hospital, providing quality healthcare services to the nation.</p>
        </div>
        <div class="footer-section">
          <h3>Quick Links</h3>
          <ul>
            <li><a href="patient.html">Patient Portal</a></li>
            <li><a href="staff.html">Staff Portal</a></li>
            <li><a href="admin.html">Admin Portal</a></li>
            <li><a href="display.html">Public Display</a></li>
          </ul>
        </div>
        <div class="footer-section">
          <h3>Contact</h3>
          <p>Queen Elizabeth Central Hospital<br>
          Blantyre, Malawi<br>
          Phone: +265 1 871 111</p>
        </div>
      </div>
      <div class="footer-bottom">
        <p data-i18n="footer_line1">&copy; 2023 Queen Elizabeth Central Hospital - Queue Management System</p>
      
      y
      </div>
    </div>
  </footer>

  <script src="../js/auth.js"></script>
  <script src="../js/queue.js"></script>
  <script src="../js/style.js"></script>
  <script>
    // Wait for page to fully load before checking role
    window.addEventListener('load', function() {
      console.log('=== STAFF.HTML LOADED ===');
      // Require staff or admin role
      const hasAccess = requireRole(['staff', 'admin']);
      if (!hasAccess) {
        console.error('Access denied, requireRole returned false');
        return;
      }
      console.log('âœ“ Access granted to staff page');
    });

    let autoRefreshInterval = null;
    let currentDepartment = null;
    let isQueuePaused = false;

    // Handler for marking patient as attended
    async function handleMarkAttended(tokenId, departmentCode) {
      const confirmed = await showConfirm('Mark this patient as attended?', { 
        confirmText: 'Mark Attended', 
        cancelText: 'Cancel' 
      });
      if (confirmed) {
        const result = await markPatientAttended(tokenId);
        if (result.success) {
          await refreshQueueDisplay(departmentCode, true);
        }
      }
    }

    // Handler for reassigning patient
    async function handleReassign(tokenId, currentDept) {
      const departments = [
        { code: 'opd', name: 'Outpatient Department (OPD)' },
        { code: 'maternity', name: 'Maternity' },
        { code: 'emergency', name: 'Emergency' },
        { code: 'pediatrics', name: 'Pediatrics' }
      ];
      
      const options = departments
        .filter(d => d.code !== currentDept)
        .map(d => `${d.code}: ${d.name}`)
        .join('\n');
      
      const newDept = prompt(`Reassign patient to:\n${options}\n\nEnter department code (opd, maternity, emergency, pediatrics):`);
      
      if (newDept && ['opd', 'maternity', 'emergency', 'pediatrics'].includes(newDept.toLowerCase())) {
        const result = await reassignPatient(tokenId, newDept.toLowerCase());
        if (result.success) {
          await refreshQueueDisplay(currentDept, true);
        }
      } else if (newDept) {
        showToast('Invalid department code', 'error');
      }
    }

    // Department selector change handler
    document.getElementById('staff-department').addEventListener('change', (e) => {
      currentDepartment = e.target.value;
      
      // Stop previous auto-refresh
      if (autoRefreshInterval) {
        stopAutoRefresh(autoRefreshInterval);
      }
      
      // Start new auto-refresh for selected department if not paused
      if (!isQueuePaused) {
        autoRefreshInterval = startAutoRefresh(currentDepartment, 10000, true);
      } else {
        refreshQueueDisplay(currentDepartment, true);
      }
      
      showToast(`Switched to ${formatDepartmentName(currentDepartment)}`, 'info');
    });

    // Call next patient button
    document.getElementById('call-next-btn').addEventListener('click', async () => {
      const result = await callNextPatient(currentDepartment);
      
      if (result.success) {
        // Refresh the queue display
        await refreshQueueDisplay(currentDepartment, true);
      }
    });

    // Pause queue button - now pauses the actual queue in the database
    document.getElementById('pause-queue-btn').addEventListener('click', async () => {
      const result = await pauseQueue(currentDepartment);
      
      if (result.success) {
        isQueuePaused = true;
        
        // Stop auto-refresh
        if (autoRefreshInterval) {
          stopAutoRefresh(autoRefreshInterval);
          autoRefreshInterval = null;
        }
        
        document.getElementById('pause-queue-btn').textContent = 'Queue Paused';
        document.getElementById('pause-queue-btn').disabled = true;
        document.getElementById('pause-queue-btn').classList.remove('btn-secondary');
        document.getElementById('pause-queue-btn').classList.add('btn-warning');
        document.getElementById('resume-queue-btn').style.display = 'inline-block';
        document.getElementById('call-next-btn').disabled = true;
      }
    });

    // Resume queue button - now resumes the actual queue in the database
    document.getElementById('resume-queue-btn').addEventListener('click', async () => {
      const result = await resumeQueue(currentDepartment);
      
      if (result.success) {
        isQueuePaused = false;
        
        // Start auto-refresh
        autoRefreshInterval = startAutoRefresh(currentDepartment, 10000, true);
        
        document.getElementById('pause-queue-btn').textContent = 'Pause Queue';
        document.getElementById('pause-queue-btn').disabled = false;
        document.getElementById('pause-queue-btn').classList.remove('btn-warning');
        document.getElementById('pause-queue-btn').classList.add('btn-secondary');
        document.getElementById('resume-queue-btn').style.display = 'none';
        document.getElementById('call-next-btn').disabled = false;
      }
    });

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
      // Read initial department from selector
      const deptSelect = document.getElementById('staff-department');
      currentDepartment = (deptSelect && deptSelect.value) ? deptSelect.value : 'opd';
      
      // Start auto-refresh for selected department with actions enabled
      autoRefreshInterval = startAutoRefresh(currentDepartment, 10000, true);
      
      // Hide resume button initially
      document.getElementById('resume-queue-btn').style.display = 'none';
    });

    // Clean up on page unload
    window.addEventListener('beforeunload', () => {
      if (autoRefreshInterval) {
        stopAutoRefresh(autoRefreshInterval);
      }
    });
  </script>
</body>
</html>
